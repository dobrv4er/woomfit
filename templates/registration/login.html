{% extends "base.html" %}
{% block title %}Вход — WOOM FIT{% endblock %}
{% block content %}
  <h2 class="section-title">Вход</h2>
  <form method="post" class="card">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="muted" style="font-weight:900; color:#973e3e; margin-bottom:8px;">
        {% for error in form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
    <div class="list">
      <div>
        <label class="muted" style="font-weight:900;">Телефон или email</label>
        <input type="text" id="id_username" name="username" value="{{ request.POST.username|default:'' }}" autocomplete="username" placeholder="+7 999 999 99 99 или client@example.com" required>
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Пароль</label>
        <input type="password" name="password" required>
      </div>
    </div>
    <div style="margin-top:14px;">
      <button class="btn btn--primary btn--full" type="submit">Войти</button>
    </div>
  </form>
  <div class="muted" style="text-align:center; margin-top:10px; font-weight:800;">
    Забыли пароль?
    <a href="{% url 'accounts:password_reset_request' %}" style="color:var(--pink); font-weight:900;">Восстановить</a>
  </div>
    <div class="muted" style="text-align:center; margin-top:12px; font-weight:800;">
  Нет аккаунта?
  <a href="{% url 'accounts:signup' %}" style="color:var(--pink); font-weight:900;">Зарегистрироваться</a>
</div>

<script>
(function() {
  const phoneInput = document.getElementById("id_username");
  if (!phoneInput) return;

  function shouldKeepAsText(raw) {
    return /[A-Za-zА-Яа-яЁё]/.test(raw || "") || (raw || "").includes("@");
  }

  function normalizePhone(raw) {
    let digits = (raw || "").replace(/\D+/g, "");
    if (digits.length === 10 && digits.startsWith("9")) digits = "7" + digits;
    if (digits.length === 11 && digits.startsWith("8")) digits = "7" + digits.slice(1);
    return digits;
  }

  function formatPhone(raw) {
    const digits = normalizePhone(raw).slice(0, 11);
    if (!digits) return "";
    if (!digits.startsWith("7")) return "+" + digits;

    let out = "+7";
    if (digits.length > 1) out += " " + digits.slice(1, 4);
    if (digits.length > 4) out += " " + digits.slice(4, 7);
    if (digits.length > 7) out += " " + digits.slice(7, 9);
    if (digits.length > 9) out += " " + digits.slice(9, 11);
    return out.trim();
  }

  function applyFormat() {
    if (shouldKeepAsText(phoneInput.value)) return;
    phoneInput.value = formatPhone(phoneInput.value);
  }

  phoneInput.addEventListener("input", applyFormat);
  phoneInput.addEventListener("blur", applyFormat);
  const form = phoneInput.closest("form");
  if (form) form.addEventListener("submit", applyFormat);
  applyFormat();
})();
</script>

{% endblock %}
