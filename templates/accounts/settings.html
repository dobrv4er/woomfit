{% extends "base.html" %}
{% block title %}Профиль и личные данные — WOOM FIT{% endblock %}
{% block topbar_left %}
  <a class="btn btn--ghost" style="padding:8px 10px; border-radius:14px;" href="{% url 'accounts:profile' %}">←</a>
{% endblock %}
{% block content %}
  <h2 class="section-title">Профиль и личные данные</h2>

  <div class="card" style="margin-bottom:12px;">
    <div style="font-weight:900; margin-bottom:10px;">Клуб</div>
    <div class="muted">{{ request.user.club }}</div>
    <hr style="margin:14px 0;">
    <div style="font-weight:900; margin-bottom:10px;">Карта</div>
    <div class="muted">{% if request.user.club_card %}{{ request.user.club_card }}{% else %}Нет клубной карты{% endif %}</div>
  </div>

  <form method="post" class="card" style="margin-bottom:12px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="personal">
    <div style="font-weight:900; margin-bottom:10px;">Личные данные</div>
    {% if profile_form.non_field_errors %}
      <div class="muted" style="margin-bottom:10px; color:#973e3e; font-weight:900;">
        {% for error in profile_form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
    <div class="list">
      <div>
        <label class="muted" style="font-weight:900;">Дата рождения</label>
        {{ profile_form.birth_date }}
        {% if profile_form.birth_date.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in profile_form.birth_date.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Телефон</label>
        {{ profile_form.phone }}
        {% if profile_form.phone.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in profile_form.phone.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Email</label>
        {{ profile_form.email }}
        {% if profile_form.email.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in profile_form.email.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    <div style="margin-top:14px;">
      <button class="btn btn--primary btn--full" type="submit">Сохранить личные данные</button>
    </div>
  </form>

  <form method="post" class="card" style="margin-bottom:12px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="name">
    <div style="font-weight:900; margin-bottom:10px;">Имя клиента</div>
    {% if name_form.non_field_errors %}
      <div class="muted" style="margin-bottom:10px; color:#973e3e; font-weight:900;">
        {% for error in name_form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
    <div class="list">
      <div>
        <label class="muted" style="font-weight:900;">Имя</label>
        {{ name_form.first_name }}
        {% if name_form.first_name.errors %}
          <div class="muted" style="margin-top:4px; color:#973e3e; font-weight:900;">
            {% for error in name_form.first_name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Фамилия</label>
        {{ name_form.last_name }}
        {% if name_form.last_name.errors %}
          <div class="muted" style="margin-top:4px; color:#973e3e; font-weight:900;">
            {% for error in name_form.last_name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    <div style="margin-top:14px;">
      <button class="btn btn--primary btn--full" type="submit">Сохранить имя</button>
    </div>
  </form>

  <form method="post" class="card" style="margin-bottom:12px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="password">
    <div style="font-weight:900; margin-bottom:10px;">Смена пароля</div>
    {% if password_form.non_field_errors %}
      <div class="muted" style="margin-bottom:10px; color:#973e3e; font-weight:900;">
        {% for error in password_form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
    <div class="list">
      <div>
        <label class="muted" style="font-weight:900;">Текущий пароль</label>
        {{ password_form.old_password }}
        {% if password_form.old_password.errors %}
          <div class="muted" style="margin-top:4px; color:#973e3e; font-weight:900;">
            {% for error in password_form.old_password.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Новый пароль</label>
        {{ password_form.new_password1 }}
        {% if password_form.new_password1.help_text %}
          <div class="muted" style="font-weight:700; margin-top:6px;">
            {{ password_form.new_password1.help_text|safe }}
          </div>
        {% endif %}
        {% if password_form.new_password1.errors %}
          <div class="muted" style="margin-top:4px; color:#973e3e; font-weight:900;">
            {% for error in password_form.new_password1.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Повтор нового пароля</label>
        {{ password_form.new_password2 }}
        {% if password_form.new_password2.help_text %}
          <div class="muted" style="font-weight:700; margin-top:6px;">
            {{ password_form.new_password2.help_text|safe }}
          </div>
        {% endif %}
        {% if password_form.new_password2.errors %}
          <div class="muted" style="margin-top:4px; color:#973e3e; font-weight:900;">
            {% for error in password_form.new_password2.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    <div style="margin-top:14px;">
      <button class="btn btn--primary btn--full" type="submit">Обновить пароль</button>
    </div>
  </form>

  <form method="post" class="card">
    {% csrf_token %}
    <input type="hidden" name="action" value="logout">
    <div style="font-weight:900; margin-bottom:10px;">Сессия</div>
    <div class="muted" style="margin-bottom:10px;">Выход завершит текущий вход в аккаунт.</div>
    <button class="btn btn--ghost btn--full" type="submit">Выйти из аккаунта</button>
  </form>

  <script>
  (function() {
    const phoneInput = document.getElementById("id_phone");
    if (!phoneInput) return;

    function normalizePhone(raw) {
      let digits = (raw || "").replace(/\D+/g, "");
      if (digits.length === 10 && digits.startsWith("9")) digits = "7" + digits;
      if (digits.length === 11 && digits.startsWith("8")) digits = "7" + digits.slice(1);
      return digits;
    }

    function formatPhone(raw) {
      const digits = normalizePhone(raw).slice(0, 11);
      if (!digits) return "";
      if (!digits.startsWith("7")) return "+" + digits;

      let out = "+7";
      if (digits.length > 1) out += " " + digits.slice(1, 4);
      if (digits.length > 4) out += " " + digits.slice(4, 7);
      if (digits.length > 7) out += " " + digits.slice(7, 9);
      if (digits.length > 9) out += " " + digits.slice(9, 11);
      return out.trim();
    }

    function applyFormat() {
      phoneInput.value = formatPhone(phoneInput.value);
    }

    phoneInput.addEventListener("input", applyFormat);
    phoneInput.addEventListener("blur", applyFormat);
    const form = phoneInput.closest("form");
    if (form) form.addEventListener("submit", applyFormat);
    applyFormat();
  })();
  </script>
{% endblock %}
