{% extends "base.html" %}
{% block title %}Регистрация — WOOM FIT{% endblock %}
{% block topbar_left %}
  <a class="btn btn--ghost" style="padding:8px 10px; border-radius:14px;" href="{% url 'login' %}">←</a>
{% endblock %}
{% block content %}
  <h2 class="section-title">Регистрация</h2>

  <form method="post" class="card">
    {% csrf_token %}
    {{ form.username }}
    {% if form.non_field_errors %}
      <div class="muted" style="font-weight:900; color:#973e3e; margin-bottom:8px;">
        {% for error in form.non_field_errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
      </div>
    {% endif %}
    <div class="list">
      <div>
        <label class="muted" style="font-weight:900;">Имя</label>
        {{ form.first_name }}
        {% if form.first_name.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.first_name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Фамилия</label>
        {{ form.last_name }}
        {% if form.last_name.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.last_name.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Телефон</label>
        {{ form.phone }}
        {% if form.phone.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.phone.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Email</label>
        {{ form.email }}
        {% if form.email.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.email.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Пароль</label>
        {{ form.password1 }}
        {% if form.password1.help_text %}
          <div class="muted" style="font-weight:700; margin-top:6px;">
            {{ form.password1.help_text|safe }}
          </div>
        {% endif %}
        {% if form.password1.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.password1.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Повтор пароля</label>
        {{ form.password2 }}
        {% if form.password2.help_text %}
          <div class="muted" style="font-weight:700; margin-top:6px;">
            {{ form.password2.help_text|safe }}
          </div>
        {% endif %}
        {% if form.password2.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.password2.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label style="display:flex; gap:10px; align-items:flex-start; font-weight:800; color:#334155;">
          {{ form.agree_offer }}
          <span>
            Я принимаю <a href="{% url 'core:public_offer' %}" target="_blank" rel="noopener" style="color:var(--pink); font-weight:900;">публичную оферту</a> и
            <a href="{% url 'core:refund_policy' %}" target="_blank" rel="noopener" style="color:var(--pink); font-weight:900;">условия оплаты/возврата</a>
          </span>
        </label>
        {% if form.agree_offer.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.agree_offer.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label style="display:flex; gap:10px; align-items:flex-start; font-weight:800; color:#334155;">
          {{ form.agree_personal_data }}
          <span>
            Я даю согласие на обработку персональных данных:
            <a href="{% url 'core:personal_data_consent' %}" target="_blank" rel="noopener" style="color:var(--pink); font-weight:900;">текст согласия</a>,
            <a href="{% url 'core:privacy' %}" target="_blank" rel="noopener" style="color:var(--pink); font-weight:900;">политика конфиденциальности</a>
          </span>
        </label>
        {% if form.agree_personal_data.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.agree_personal_data.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
    </div>

    <div style="margin-top:14px;">
      <button class="btn btn--primary btn--full" type="submit">Создать аккаунт</button>
    </div>
  </form>

  <script>
  (function() {
    const phoneInput = document.getElementById("id_phone");
    if (!phoneInput) return;

    function normalizePhone(raw) {
      let digits = (raw || "").replace(/\D+/g, "");
      if (digits.length === 10 && digits.startsWith("9")) digits = "7" + digits;
      if (digits.length === 11 && digits.startsWith("8")) digits = "7" + digits.slice(1);
      return digits;
    }

    function formatPhone(raw) {
      const digits = normalizePhone(raw).slice(0, 11);
      if (!digits) return "";
      if (!digits.startsWith("7")) return "+" + digits;

      let out = "+7";
      if (digits.length > 1) out += " " + digits.slice(1, 4);
      if (digits.length > 4) out += " " + digits.slice(4, 7);
      if (digits.length > 7) out += " " + digits.slice(7, 9);
      if (digits.length > 9) out += " " + digits.slice(9, 11);
      return out.trim();
    }

    function applyFormat() {
      phoneInput.value = formatPhone(phoneInput.value);
    }

    phoneInput.addEventListener("input", applyFormat);
    phoneInput.addEventListener("blur", applyFormat);
    const form = phoneInput.closest("form");
    if (form) form.addEventListener("submit", applyFormat);
    applyFormat();
  })();
  </script>
{% endblock %}
