{% extends "base.html" %}
{% block title %}Личные данные — WOOM FIT{% endblock %}
{% block topbar_left %}
  <a class="btn btn--ghost" style="padding:8px 10px; border-radius:14px;" href="{% url 'accounts:profile' %}">←</a>
{% endblock %}
{% block content %}
  <div class="card">
    <div style="font-weight:900; margin-bottom:10px;">Клуб</div>
    <div class="muted">{{ request.user.club }}</div>
    <hr style="margin:14px 0;">
    <div style="font-weight:900; margin-bottom:10px;">Карта</div>
    <div class="muted">{% if request.user.club_card %}{{ request.user.club_card }}{% else %}Нет клубной карты{% endif %}</div>
  </div>

  <h2 class="section-title">О вас</h2>

  <form method="post" class="card">
    {% csrf_token %}
    <div class="list">
      <div class="muted" style="font-weight:800;">
        Имя изменяется на странице
        <a href="{% url 'accounts:settings' %}" style="color:var(--pink); font-weight:900;">настроек профиля</a>.
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Дата рождения</label>
        {{ form.birth_date }}
        {% if form.birth_date.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.birth_date.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
      <div>
        <label class="muted" style="font-weight:900;">Телефон</label>
        {{ form.phone }}
        {% if form.phone.errors %}
          <div class="muted" style="font-weight:900; color:#973e3e; margin-top:4px;">
            {% for error in form.phone.errors %}{{ error }}{% if not forloop.last %}<br>{% endif %}{% endfor %}
          </div>
        {% endif %}
      </div>
    </div>
    <div style="margin-top:14px;">
      <button class="btn btn--primary btn--full" type="submit">Сохранить данные</button>
    </div>
  </form>

  <script>
  (function() {
    const phoneInput = document.getElementById("id_phone");
    if (!phoneInput) return;

    function normalizePhone(raw) {
      let digits = (raw || "").replace(/\D+/g, "");
      if (digits.length === 10 && digits.startsWith("9")) digits = "7" + digits;
      if (digits.length === 11 && digits.startsWith("8")) digits = "7" + digits.slice(1);
      return digits;
    }

    function formatPhone(raw) {
      const digits = normalizePhone(raw).slice(0, 11);
      if (!digits) return "";
      if (!digits.startsWith("7")) return "+" + digits;

      let out = "+7";
      if (digits.length > 1) out += " " + digits.slice(1, 4);
      if (digits.length > 4) out += " " + digits.slice(4, 7);
      if (digits.length > 7) out += " " + digits.slice(7, 9);
      if (digits.length > 9) out += " " + digits.slice(9, 11);
      return out.trim();
    }

    function applyFormat() {
      phoneInput.value = formatPhone(phoneInput.value);
    }

    phoneInput.addEventListener("input", applyFormat);
    phoneInput.addEventListener("blur", applyFormat);
    const form = phoneInput.closest("form");
    if (form) form.addEventListener("submit", applyFormat);
    applyFormat();
  })();
  </script>
{% endblock %}
