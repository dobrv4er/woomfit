{% extends "base.html" %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å ‚Äî WOOM FIT{% endblock %}

{% block content %}
{% with w=request.user.wallet %}
  <div class="card" style="margin-bottom:12px;">
    <div style="font-weight:900; font-size:16px;">–ö–æ—à–µ–ª—ë–∫</div>
    <div style="margin-top:6px; font-weight:900; font-size:22px;">
      {{ w.balance }} ‚ÇΩ
    </div>
    <div class="muted" style="margin-top:6px;">
      –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –æ–ø–ª–∞—Ç –∏ –≤–æ–∑–≤—Ä–∞—Ç–æ–≤
    </div>
  </div>
{% endwith %}

<style>
  .profile-wrap { display:flex; flex-direction:column; gap:14px; }

  .profile-hero{
    border-radius:22px;
    padding:18px 18px;
    background: linear-gradient(90deg, #ff4f8f 0%, #ff7aa7 100%);
    color:#fff;
    display:flex;
    align-items:center;
    justify-content:space-between;
    text-decoration:none;
  }
  .profile-hero__left{display:flex; align-items:center; gap:14px;}
  .profile-hero__avatar{
    width:46px; height:46px; border-radius:50%;
    background: rgba(255,255,255,0.25);
    display:flex; align-items:center; justify-content:center;
    font-weight:900;
  }
  .profile-hero__name{font-weight:900; font-size:22px; line-height:1.05;}
  .profile-hero__club{opacity:.9; font-weight:800; margin-top:2px;}
  .profile-hero__arrow{font-size:28px; opacity:.9; padding-left:10px;}

  /* ‚úÖ –°–µ–≥–º–µ–Ω—Ç (—á–∏–Ω–∏—Ç –∫–ª–∏–∫–∏): z-index + pointer-events */
  .segmented{
    background: rgba(255,79,143,0.10);
    border-radius:22px;
    padding:10px;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;

    position: relative;
    z-index: 10;
    pointer-events: auto;
  }
  .seg-btn{
    border:0;
    border-radius:18px;
    padding:14px 12px;
    font-weight:900;
    font-size:18px;
    cursor:pointer;

    background:#fff;
    color:#111827;
    box-shadow: 0 8px 16px rgba(0,0,0,0.08);

    pointer-events: auto;
  }
  .seg-btn.is-active{
    background:#ff4f8f;
    color:#fff;
    box-shadow: 0 10px 18px rgba(255,79,143,0.28);
  }

  .panel{
    border-radius:22px;
    background:#fff;
    box-shadow: 0 10px 18px rgba(0,0,0,0.06);
    padding:18px;
    min-height:260px;
  }
  .empty{
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    gap:12px;
    text-align:center;
    padding:22px 10px;
  }
  .empty .emoji{font-size:40px;}
  .empty .text{font-weight:900; color:#6b7280;}
  .cta{
    display:inline-block;
    padding:12px 18px;
    border-radius:16px;
    background:#ff4f8f;
    color:#fff;
    font-weight:900;
    text-decoration:none;
  }

  .hidden{display:none !important;}

  .memberships-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    padding:8px 2px 10px;
  }
  .memberships-title{
    font-size:16px;
    color:#0f172a;
    font-weight:900;
  }
  .memberships-count{
    background:#fff0f5;
    border:1px solid #ffd7e6;
    border-radius:999px;
    min-width:28px;
    text-align:center;
    padding:2px 8px;
    font-size:12px;
    color:#e94c7a;
    font-weight:900;
  }

  .mlist{display:grid; gap:8px;}
  .mcard{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:10px 11px;
  }
  .mrow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
  }
  .mttl{font-weight:900; font-size:15px; line-height:1.2;}
  .mstatus{
    display:inline-flex;
    align-items:center;
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
    font-weight:900;
    white-space:nowrap;
    border:1px solid #e2e8f0;
    color:#475569;
    background:#f8fafc;
  }
  .mstatus--ok{
    background:#dcfce7;
    color:#166534;
    border:1px solid #bbf7d0;
  }
  .mstatus--bad{
    background:#fee2e2;
    color:#991b1b;
    border:1px solid #fecaca;
  }

  .mchips{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:7px;
  }
  .mchip{
    display:inline-flex;
    align-items:center;
    padding:2px 7px;
    border-radius:999px;
    border:1px solid #e2e8f0;
    background:#f8fafc;
    color:#334155;
    font-size:11px;
    font-weight:800;
  }

  .mmeta{
    margin-top:8px;
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:5px 8px;
  }
  .mfield{display:grid; gap:1px;}
  .mkey{font-size:11px; color:#94a3b8; font-weight:800;}
  .mval{font-size:12px; color:#0f172a; font-weight:900;}

  .journal-list{display:grid; gap:8px;}
  .jitem{
    border:1px solid var(--border);
    background:#fff;
    border-radius:14px;
    padding:10px 11px;
    display:flex;
    justify-content:space-between;
    gap:10px;
  }
  .jmain{min-width:0;}
  .jtitle{
    font-size:13px;
    font-weight:900;
    color:#0f172a;
    line-height:1.25;
  }
  .jsub{
    margin-top:3px;
    font-size:12px;
    color:#64748b;
    font-weight:800;
    line-height:1.25;
  }
  .jside{
    display:flex;
    flex-direction:column;
    align-items:flex-end;
    gap:3px;
    white-space:nowrap;
  }
  .jdate{
    font-size:11px;
    color:#94a3b8;
    font-weight:800;
  }
  .jamount{
    font-size:12px;
    font-weight:900;
    color:#334155;
  }
  .jamount--plus{color:#15803d;}
  .jamount--minus{color:#b91c1c;}

  @media (max-width: 760px){
    .mmeta{grid-template-columns:1fr;}
    .jitem{
      flex-direction:column;
      align-items:flex-start;
    }
    .jside{
      align-items:flex-start;
      white-space:normal;
    }
  }
</style>

<div class="profile-wrap">
  <a class="profile-hero" href="{% url 'accounts:settings' %}" aria-label="–ü—Ä–æ—Ñ–∏–ª—å –∏ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ">
    <div class="profile-hero__left">
      <div class="profile-hero__avatar">üë§</div>
      <div>
        <div class="profile-hero__name">
          {% if user.is_authenticated %}
            {{ user.get_full_name|default:"–ö–ª–∏–µ–Ω—Ç" }}
          {% else %}
            –ì–æ—Å—Ç—å
          {% endif %}
        </div>
        <div class="profile-hero__club">WOOM FIT</div>
      </div>
    </div>
    <div class="profile-hero__arrow">‚Ä∫</div>
  </a>

  <div class="segmented" id="profileTabs">
    <button type="button" class="seg-btn is-active" data-tab="services">–£—Å–ª—É–≥–∏</button>
    <button type="button" class="seg-btn" data-tab="journal">–ñ—É—Ä–Ω–∞–ª</button>
  </div>

  <div class="panel" id="tab-services">
    <div class="memberships-head">
      <span class="memberships-title">–ê–±–æ–Ω–µ–º–µ–Ω—Ç—ã</span>
      <span class="memberships-count">{{ memberships|length }}</span>
    </div>

    {% if memberships %}
      <div class="mlist">
        {% for m in memberships %}
          <div class="mcard">
            <div class="mrow">
              <div class="mttl">{{ m.title }}</div>
              {% if m.is_pending_activation %}
                <div class="mstatus">–û–∂–∏–¥–∞–µ—Ç –∞–∫—Ç–∏–≤–∞—Ü–∏–∏</div>
              {% elif m.start_date and m.start_date > today %}
                <div class="mstatus">–°–∫–æ—Ä–æ –∞–∫—Ç–∏–≤–µ–Ω</div>
              {% elif m.is_active and m.active_by_date %}
                <div class="mstatus mstatus--ok">–ê–∫—Ç–∏–≤–µ–Ω</div>
              {% else %}
                <div class="mstatus mstatus--bad">–ù–µ –∞–∫—Ç–∏–≤–µ–Ω</div>
              {% endif %}
            </div>

            <div class="mchips">
              <span class="mchip">{{ m.get_kind_display }}</span>
              <span class="mchip">{% if m.scope %}{{ m.get_scope_display }}{% else %}–í—Å–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏{% endif %}</span>
              {% if m.left_visits != None %}
                <span class="mchip">–û—Å—Ç–∞–ª–æ—Å—å: {{ m.left_visits }}</span>
              {% endif %}
              {% if m.total_visits != None %}
                <span class="mchip">–í—Å–µ–≥–æ: {{ m.total_visits }}</span>
              {% endif %}
            </div>

            <div class="mmeta">
              <div class="mfield">
                <div class="mkey">–ù–∞—á–∞–ª–æ</div>
                <div class="mval">{% if m.start_date %}{{ m.start_date|date:"d.m.Y" }}{% else %}‚Äî{% endif %}</div>
              </div>
              <div class="mfield">
                <div class="mkey">–û–∫–æ–Ω—á–∞–Ω–∏–µ</div>
                <div class="mval">{% if m.end_date %}{{ m.end_date|date:"d.m.Y" }}{% else %}‚Äî{% endif %}</div>
              </div>
              <div class="mfield">
                <div class="mkey">–ü–æ–∫—É–ø–∫–∞</div>
                <div class="mval">{{ m.created_at|date:"d.m.Y H:i" }}</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">
        <div class="emoji">üèãÔ∏è</div>
        <div class="text">–£ –≤–∞—Å –Ω–µ—Ç –Ω–µ–∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–Ω—ã—Ö –∞–±–æ–Ω–µ–º–µ–Ω—Ç–æ–≤</div>
        <a class="cta" href="/shop/">–ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω</a>
      </div>
    {% endif %}
  </div>

  <div class="panel hidden" id="tab-journal">
    {% if journal_events %}
      <div class="journal-list">
        {% for e in journal_events %}
          <div class="jitem">
            <div class="jmain">
              <div class="jtitle">{{ e.title }}</div>
              {% if e.subtitle %}
                <div class="jsub">{{ e.subtitle }}</div>
              {% endif %}
            </div>
            <div class="jside">
              {% if e.amount %}
                <div class="jamount {% if e.amount_class == 'plus' %}jamount--plus{% elif e.amount_class == 'minus' %}jamount--minus{% endif %}">
                  {{ e.amount }}
                </div>
              {% endif %}
              <div class="jdate">{{ e.at|date:"d.m.Y H:i" }}</div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty">
        <div class="emoji">üìì</div>
        <div class="text">–ñ—É—Ä–Ω–∞–ª –ø–æ–∫–∞ –ø—É—Å—Ç</div>
      </div>
    {% endif %}
  </div>
</div>

<script>
(function(){
  const tabs = document.getElementById("profileTabs");
  if (!tabs) return;

  const btns = Array.from(tabs.querySelectorAll("[data-tab]"));
  const panelServices = document.getElementById("tab-services");
  const panelJournal = document.getElementById("tab-journal");

  const key = "woomfit_profile_tab";

  function setTab(name){
    btns.forEach(b => b.classList.toggle("is-active", b.dataset.tab === name));
    if (panelServices) panelServices.classList.toggle("hidden", name !== "services");
    if (panelJournal) panelJournal.classList.toggle("hidden", name !== "journal");
    try { sessionStorage.setItem(key, name); } catch(e) {}
  }

  // restore last tab
  try {
    const saved = sessionStorage.getItem(key);
    if (saved === "journal" || saved === "services") setTab(saved);
  } catch(e) {}

  tabs.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-tab]");
    if (!btn) return;
    e.preventDefault();
    setTab(btn.dataset.tab);
  }, true);
})();
</script>
{% endblock %}
