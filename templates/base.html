{% load static %}
<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}WOOM FIT{% endblock %}</title>
  <link rel="stylesheet" href="{% static 'css/app.css' %}">
</head>
<body>
  <header class="topbar">
    <div class="topbar__left">{% block topbar_left %}{% endblock %}</div>
    <a class="topbar__brand" href="{% url 'core:home' %}" aria-label="WOOM FIT"><span class="brand__dot">‚ö°</span></a>
    <div class="topbar__right">{% block topbar_right %}{% endblock %}</div>
  </header>

  <nav class="desknav">
    <a class="desknav__item {% if request.path == '/' %}is-active{% endif %}" href="{% url 'core:home' %}">–ì–ª–∞–≤–Ω–∞—è</a>
    <a class="desknav__item {% if request.path|slice:':10' == '/schedule/' %}is-active{% endif %}" href="{% url 'schedule:list' %}">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</a>
    <a class="desknav__item {% if request.path|slice:':6' == '/news/' %}is-active{% endif %}" href="{% url 'news:list' %}">–ù–æ–≤–æ—Å—Ç–∏</a>
    <a class="desknav__item {% if request.path|slice:':6' == '/shop/' %}is-active{% endif %}" href="{% url 'shop:menu' %}">–ú–∞–≥–∞–∑–∏–Ω{% if cart.count %} ({{ cart.count }}){% endif %}</a>
    <a class="desknav__item {% if request.path|slice:':9' == '/profile/' %}is-active{% endif %}" href="{% url 'accounts:profile' %}">–ü—Ä–æ—Ñ–∏–ª—å</a>
  </nav>

  <main class="page">
    {% if messages %}
      <div class="flash">
        {% for m in messages %}
          <div class="flash__item">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

  <footer class="legal-footer">
    <a href="{% url 'core:public_offer' %}">–ü—É–±–ª–∏—á–Ω–∞—è –æ—Ñ–µ—Ä—Ç–∞</a>
    <a href="{% url 'core:refund_policy' %}">–û–ø–ª–∞—Ç–∞ –∏ –≤–æ–∑–≤—Ä–∞—Ç</a>
    <a href="{% url 'core:privacy' %}">–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>
    <a href="{% url 'core:personal_data_consent' %}">–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –ü–î–Ω</a>
    <a href="{% url 'core:cookies_policy' %}">–ü–æ–ª–∏—Ç–∏–∫–∞ Cookie</a>
    <a href="{% url 'core:cookie_consent' %}">–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ Cookie</a>
    <a href="{% url 'core:cookie_settings' %}">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Cookie</a>
    <a href="{% url 'core:requisites' %}">–†–µ–∫–≤–∏–∑–∏—Ç—ã</a>
    <button type="button" id="cookieManageBtn" class="legal-footer__btn">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ cookie</button>
  </footer>

  <div id="cookieConsent" class="cookie-consent is-hidden" role="dialog" aria-modal="true" aria-labelledby="cookieTitle">
    <div class="cookie-consent__card">
      <div class="cookie-consent__title" id="cookieTitle">–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º cookie</div>
      <div class="cookie-consent__text">
        –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ cookie –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ —Ä–∞–±–æ—Ç—ã —Å–∞–π—Ç–∞.
        –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ cookie –≤–∫–ª—é—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è.
        –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <a href="{% url 'core:privacy' %}">–ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a>,
        <a href="{% url 'core:cookies_policy' %}">–ø–æ–ª–∏—Ç–∏–∫–∞ Cookie</a>,
        <a href="{% url 'core:cookie_consent' %}">—Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ Cookie</a>,
        <a href="{% url 'core:cookie_settings' %}">–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Cookie</a>.
      </div>

      <div class="cookie-consent__actions">
        <button type="button" class="btn btn--primary" data-cookie-action="accept-all">–ü—Ä–∏–Ω—è—Ç—å –≤—Å–µ</button>
        <button type="button" class="btn btn--ghost" data-cookie-action="essential-only">–¢–æ–ª—å–∫–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ</button>
        <button type="button" class="btn btn--muted" data-cookie-action="open-settings">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å</button>
      </div>

      <div id="cookieSettingsPanel" class="cookie-settings is-hidden">
        <label class="cookie-settings__row">
          <span>–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ cookie</span>
          <input type="checkbox" checked disabled>
        </label>
        <label class="cookie-settings__row">
          <span>–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ cookie</span>
          <input type="checkbox" id="cookieAnalytics">
        </label>
        <label class="cookie-settings__row">
          <span>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥–æ–≤—ã–µ cookie</span>
          <input type="checkbox" id="cookieMarketing">
        </label>
        <button type="button" class="btn btn--primary btn--full" data-cookie-action="save-settings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä</button>
      </div>
    </div>
  </div>

  <nav class="tabbar" aria-label="–ù–∏–∂–Ω–µ–µ –º–µ–Ω—é">
    <a class="tabbar__item {% if request.path == '/' %}is-active{% endif %}" href="{% url 'core:home' %}">
      <span class="tabbar__icon">‚åÇ</span>
      <span class="tabbar__label">–ì–ª–∞–≤–Ω–∞—è</span>
    </a>
    <a class="tabbar__item {% if request.path|slice:':10' == '/schedule/' %}is-active{% endif %}" href="{% url 'schedule:list' %}">
      <span class="tabbar__icon">üïí</span>
      <span class="tabbar__label">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span>
    </a>
    <a class="tabbar__item {% if request.path|slice:':6' == '/news/' %}is-active{% endif %}" href="{% url 'news:list' %}">
      <span class="tabbar__icon">üì∞</span>
      <span class="tabbar__label">–ù–æ–≤–æ—Å—Ç–∏</span>
    </a>
    <a class="tabbar__item {% if request.path|slice:':6' == '/shop/' %}is-active{% endif %}" href="{% url 'shop:menu' %}">
      <span class="tabbar__icon">üõç</span>
      <span class="tabbar__label">–ú–∞–≥–∞–∑–∏–Ω</span>
      {% if cart.count %}
        <span class="tabbar__badge">{{ cart.count }}</span>
      {% endif %}
    </a>
    <a class="tabbar__item {% if request.path|slice:':9' == '/profile/' %}is-active{% endif %}" href="{% url 'accounts:profile' %}">
      <span class="tabbar__icon">üë§</span>
      <span class="tabbar__label">–ü—Ä–æ—Ñ–∏–ª—å</span>
    </a>
  </nav>

  <script>
  (function() {
    const CONSENT_KEY = "woom_cookie_consent_v1";
    const CONSENT_COOKIE = "woom_cookie_consent";
    const CONSENT_TTL_DAYS = 180;

    const banner = document.getElementById("cookieConsent");
    const settingsPanel = document.getElementById("cookieSettingsPanel");
    const analyticsInput = document.getElementById("cookieAnalytics");
    const marketingInput = document.getElementById("cookieMarketing");
    const manageBtn = document.getElementById("cookieManageBtn");

    if (!banner || !settingsPanel || !analyticsInput || !marketingInput) return;

    function setCookie(name, value, days) {
      const maxAge = Math.floor(days * 24 * 60 * 60);
      document.cookie = `${name}=${encodeURIComponent(value)}; path=/; max-age=${maxAge}; samesite=lax`;
    }

    function getStoredConsent() {
      try {
        const raw = localStorage.getItem(CONSENT_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        if (!parsed || parsed.required !== true) return null;
        return parsed;
      } catch (e) {
        return null;
      }
    }

    function persistConsent(consent) {
      const payload = {
        required: true,
        analytics: !!consent.analytics,
        marketing: !!consent.marketing,
        updated_at: new Date().toISOString(),
      };
      try {
        localStorage.setItem(CONSENT_KEY, JSON.stringify(payload));
      } catch (e) {}
      setCookie(CONSENT_COOKIE, JSON.stringify(payload), CONSENT_TTL_DAYS);
      document.documentElement.dataset.cookieAnalytics = payload.analytics ? "1" : "0";
      document.documentElement.dataset.cookieMarketing = payload.marketing ? "1" : "0";
      hideBanner();
    }

    function showBanner(openSettings) {
      banner.classList.remove("is-hidden");
      if (openSettings) {
        settingsPanel.classList.remove("is-hidden");
      } else {
        settingsPanel.classList.add("is-hidden");
      }
    }

    function hideBanner() {
      banner.classList.add("is-hidden");
      settingsPanel.classList.add("is-hidden");
    }

    function applyInputsFromConsent(consent) {
      analyticsInput.checked = !!(consent && consent.analytics);
      marketingInput.checked = !!(consent && consent.marketing);
    }

    const existingConsent = getStoredConsent();
    if (existingConsent) {
      applyInputsFromConsent(existingConsent);
      document.documentElement.dataset.cookieAnalytics = existingConsent.analytics ? "1" : "0";
      document.documentElement.dataset.cookieMarketing = existingConsent.marketing ? "1" : "0";
      hideBanner();
    } else {
      applyInputsFromConsent({analytics: false, marketing: false});
      showBanner(false);
    }

    banner.addEventListener("click", function(event) {
      const actionBtn = event.target.closest("[data-cookie-action]");
      if (!actionBtn) return;

      const action = actionBtn.getAttribute("data-cookie-action");
      if (action === "accept-all") {
        persistConsent({analytics: true, marketing: true});
        return;
      }
      if (action === "essential-only") {
        persistConsent({analytics: false, marketing: false});
        return;
      }
      if (action === "open-settings") {
        settingsPanel.classList.toggle("is-hidden");
        return;
      }
      if (action === "save-settings") {
        persistConsent({
          analytics: analyticsInput.checked,
          marketing: marketingInput.checked,
        });
      }
    });

    if (manageBtn) {
      manageBtn.addEventListener("click", function() {
        applyInputsFromConsent(getStoredConsent() || {analytics: false, marketing: false});
        showBanner(true);
      });
    }
  })();
  </script>
  <script>
  (function() {
    const flash = document.querySelector(".flash");
    if (!flash) return;

    window.setTimeout(function() {
      flash.classList.add("is-hiding");
      window.setTimeout(function() {
        flash.remove();
      }, 220);
    }, 5000);
  })();
  </script>
</body>
</html>
